<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="6K"><title>交互式的 NPM Scripts · 6K</title><meta name="description" content="尽管 Webpack 2 默认支持从终端传参数到配置文件中来实现定制：

–env.x=xxx

但每次开发都需要在命令行输入冗长且难记的各种参数:

npm run dev – –env.p=xxx –env.s –env.r …

希望可以屏蔽这些细节，提供一个交互式的终端用户界面。先看一下最终"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/blog/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/blog/css/style.css"><link rel="stylesheet" href="/blog/css/blog_basic.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/blog/images/avatar.png" style="width:150px;"><h3 title=""><a href="/">6K</a></h3><div class="description"><p>认真做事 低调做人</p></div></div></div><ul class="social-links"></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/blog/">首页</a></li><li><a href="https://l19861225q.github.io/blog/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>交互式的 NPM Scripts</a></h3></div><div class="post-content"><p>尽管 Webpack 2 默认支持从终端传参数到配置文件中来实现定制：</p>
<blockquote>
<p>–env.x=xxx</p>
</blockquote>
<p>但每次开发都需要在命令行输入冗长且难记的各种参数:</p>
<blockquote>
<p>npm run dev – –env.p=xxx –env.s –env.r …</p>
</blockquote>
<p>希望可以屏蔽这些细节，提供一个交互式的终端用户界面。<br>先看一下最终效果：</p>
<img src="/blog/2017/06/29/interactive-npm-scripts/interactive.gif">
<h2 id="支持会话的终端界面-Inquirer-js"><a href="#支持会话的终端界面-Inquirer-js" class="headerlink" title="支持会话的终端界面 - Inquirer.js"></a>支持会话的终端界面 - Inquirer.js</h2><blockquote>
<p><a href="https://github.com/SBoudrias/Inquirer.js" target="_blank" rel="noopener">Inquirer.js</a> 可以预设一组问题来收集用户答案，支持过滤、验证等特性。</p>
</blockquote>
<h3 id="定义问题"><a href="#定义问题" class="headerlink" title="定义问题"></a>定义问题</h3><p>这里我需要两个提问：</p>
<ul>
<li>将要开发哪个项目（必填）</li>
<li>可选配置（是否生成雪碧图、是否使用 CSS Module 等）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> questions = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'project'</span>,</span><br><span class="line">    message: <span class="string">'Please input the project name:'</span>,</span><br><span class="line">    <span class="comment">// 验证：这个答案必填才继续后面的问题</span></span><br><span class="line">    validate: <span class="function">(<span class="params">str</span>) =&gt;</span> <span class="built_in">Boolean</span>(str.length)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'conf'</span>,</span><br><span class="line">    type: <span class="string">'checkbox'</span>,</span><br><span class="line">    message: <span class="string">'Please make your choice:'</span>,</span><br><span class="line">    choices: [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">'Sprite (是否生成雪碧图)'</span>, <span class="attr">value</span>: <span class="string">'s'</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">'Retina (是否支持 Retina 雪碧图)'</span>, <span class="attr">value</span>: <span class="string">'r'</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">'CSS Module (是否使用 CSS Module)'</span>, <span class="attr">value</span>: <span class="string">'m'</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">'Use React (是否使用 React, 默认 Preact)'</span>, <span class="attr">value</span>: <span class="string">'R'</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="收集答案"><a href="#收集答案" class="headerlink" title="收集答案"></a>收集答案</h3><p><code>--color</code> 来让终端始终高亮显示强调的内容。Inquirer 支持 Promise 特性，代码看起来也十分的简介、优雅。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> args = [<span class="string">'--color'</span>]</span><br><span class="line">inquirer.prompt(questions).then(<span class="function"><span class="keyword">function</span> (<span class="params">&#123; project, conf &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 拼接成 Webpack 2 规定的参数格式</span></span><br><span class="line">  args.push(<span class="string">`--env.p=<span class="subst">$&#123;project&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">  conf.map(<span class="function">(<span class="params">command</span>) =&gt;</span> args.push(<span class="string">`--env.<span class="subst">$&#123;command&#125;</span>`</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="终端-Loading-动画-ora"><a href="#终端-Loading-动画-ora" class="headerlink" title="终端 Loading 动画 - ora"></a>终端 Loading 动画 - ora</h2><blockquote>
<p><a href="https://github.com/sindresorhus/ora" target="_blank" rel="noopener">ora</a> 优雅的终端 Loading 动画</p>
</blockquote>
<p>因为 webpack 的配置文件使用了 ES6，在启动前需要先经过 Babel 转码，需要一定的时间，这时如果能给终端 Loading 的反馈，用户体验将是美好的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'\n'</span>) <span class="comment">// 和上面 Inquirer 的问题保留一个空行更美观</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oraInstance = ora(&#123;</span><br><span class="line">  color: <span class="string">'cyan'</span>,</span><br><span class="line">  text: <span class="string">'Please waiting for the webpack start'</span></span><br><span class="line">&#125;).start()</span><br></pre></td></tr></table></figure>
<p>这里返回了 ora 的实例，后面需要显示的调用 <a href="https://github.com/sindresorhus/ora#api" target="_blank" rel="noopener">ora 的 API</a> <code>stop</code> &amp; <code>clear</code> 来停止并移除 ora .</p>
<h2 id="用于-Node-js-的-shell-命令-shellJS"><a href="#用于-Node-js-的-shell-命令-shellJS" class="headerlink" title="用于 Node.js 的 shell 命令 - shellJS"></a>用于 Node.js 的 shell 命令 - shellJS</h2><blockquote>
<p><a href="https://github.com/shelljs/shelljs" target="_blank" rel="noopener">ShellJS</a> 是 Node.js API 之上的 shell 命令的便携式（Windows / Linux / OS X）实现。</p>
</blockquote>
<p>我需要在 js 文件里执行原先定义在 <code>package.json</code> 中的 <code>scripts</code> 命令。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> child = shell.exec(<span class="string">`</span></span><br><span class="line"><span class="string">  NODE_ENV=development webpack --hide-modules <span class="subst">$&#123;args&#125;</span></span></span><br><span class="line"><span class="string">`</span>, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;) <span class="comment">// 异步执行速度更快哦</span></span><br></pre></td></tr></table></figure>
<p>这里返回了子线程的实例 child，后面会用到他的 <code>stdout</code>、<code>stderr</code> 实现监听终端输出的功能。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// npm run dev</span></span><br><span class="line"><span class="comment">// Stop and clear the ora when webpack started</span></span><br><span class="line">child.stdout.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (data.toLowerCase().includes(<span class="string">'webpack'</span>)) &#123;</span><br><span class="line">    oraInstance.stop() <span class="comment">// 停止 ora 动画</span></span><br><span class="line">    oraInstance.clear() <span class="comment">// 移除 ora</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>因为 ora 的实现原理是不断刷新终端输出来达到动画的效果，如果不移除会造成 webpack stdout 的闪现，体验很差。</p>
<p>在 <code>NODE_ENV=production</code> 模式下，Webpack 只会产生标准错误输出 stderr，所以监听有些许改变：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// npm run build</span></span><br><span class="line">child.stderr.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (data.toLowerCase().includes(<span class="string">'compiling'</span>)) &#123;</span><br><span class="line">    oraInstance.stop()</span><br><span class="line">    oraInstance.clear()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>OK~ 愉快地 coding 吧 ^_^</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-06-29</span><i class="fa fa-tag"></i><a href="/blog/categories/前端技术/" title="前端技术" class="tag">前端技术 </a><a href="/blog/tags/node/" title="node" class="tag">node </a><a href="/blog/tags/npm/" title="npm" class="tag">npm </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://l19861225q.github.io/blog/2017/06/29/interactive-npm-scripts/,6K,交互式的 NPM Scripts,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/blog/2017/10/11/fix-hammerjs-conflict/" title="解决 HammerJS 拖拽、缩放和旋转的手势问题" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/blog/2017/06/23/framework-qa/" title="前端项目架构时遇到的问题" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/blog/js/jquery.js"></script><script src="/blog/js/jquery-migrate-1.2.1.min.js"></script><script src="/blog/js/jquery.appear.js"></script></body></html>