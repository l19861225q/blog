<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="6K"><title>前端项目架构时遇到的问题 · 6K</title><meta name="description" content="本文涉及到的相关技术点不会讲解基础用法（请参考官方文档），只会针对开发中遇到的痛点展开讨论。
技术概览主要使用了以下技术栈，从环境、编译、开发，再到测试，较为全面的涵盖了目前前端开发中常用的一套流程，可作为脚手架使用。


Yarn - Node 包管理器
ES6 - ECMAScript6，下一代"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/blog/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/blog/css/style.css"><link rel="stylesheet" href="/blog/css/blog_basic.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/blog/images/avatar.png" style="width:150px;"><h3 title=""><a href="/">6K</a></h3><div class="description"><p>认真做事 低调做人</p></div></div></div><ul class="social-links"></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/blog/">首页</a></li><li><a href="https://l19861225q.github.io/blog/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>前端项目架构时遇到的问题</a></h3></div><div class="post-content"><p><strong>本文涉及到的相关技术点不会讲解基础用法（请参考官方文档），只会针对开发中遇到的痛点展开讨论。</strong></p>
<h2 id="技术概览"><a href="#技术概览" class="headerlink" title="技术概览"></a>技术概览</h2><p>主要使用了以下技术栈，从环境、编译、开发，再到测试，较为全面的涵盖了目前前端开发中常用的一套流程，可作为脚手架使用。</p>
<a id="more"></a>
<ul>
<li><a href="https://yarnpkg.com" target="_blank" rel="noopener">Yarn</a> - <small>Node 包管理器</small></li>
<li><a href="http://es6.ruanyifeng.com" target="_blank" rel="noopener">ES6</a> - <small>ECMAScript6，下一代 JS 语法</small></li>
<li><a href="https://babeljs.io" target="_blank" rel="noopener">Babel</a> - <small>ES6 编译器</small></li>
<li><a href="https://webpack.js.org" target="_blank" rel="noopener">Webpack</a> - <small>前端开发构建工具</small></li>
<li>Lint 代码检查<ul>
<li><a href="http://eslint.org" target="_blank" rel="noopener">ESLint</a> - <small>JavaScript 代码检查</small></li>
<li><a href="https://github.com/sasstools/sass-lint" target="_blank" rel="noopener">SASS Lint</a> - <small>SASS 代码检查</small></li>
<li><a href="http://htmlhint.com" target="_blank" rel="noopener">HTML Lint</a> - <small>HTML 代码检查</small></li>
</ul>
</li>
<li>React 相关<ul>
<li><a href="https://facebook.github.io/react" target="_blank" rel="noopener">React</a> - <small>React 库</small></li>
<li><a href="https://github.com/facebook/react/tree/master/packages/react-dom" target="_blank" rel="noopener">React DOM</a> - <small>React 插件，封装了和 DOM 相关的操作</small></li>
<li><a href="https://reacttraining.com/react-router" target="_blank" rel="noopener">React Router DOM</a> - <small>前端路由</small></li>
</ul>
</li>
<li>Style 相关<ul>
<li><a href="http://sass-lang.com" target="_blank" rel="noopener">SASS</a> - <small>强大的 CSS 预处理器</small><ul>
<li><a href="https://github.com/franzheidl/bemify" target="_blank" rel="noopener">Bemify</a> - <small>帮助写出 <a href="http://getbem.com" target="_blank" rel="noopener">BEM</a> 风格的 SASS 混入</small></li>
<li><a href="http://bourbon.io" target="_blank" rel="noopener">Bourbon</a> - <small>轻量的 SASS 工具集</small></li>
<li><a href="http://postcss.org" target="_blank" rel="noopener">Post CSS</a> - <small>强大的 CSS 后处理器</small></li>
</ul>
</li>
</ul>
</li>
<li>Unit Testing <a href="http://baike.baidu.com/item/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener">单元测试</a><ul>
<li><a href="https://karma-runner.github.io/1.0/index.html" target="_blank" rel="noopener">Karma</a> - <small>单元测试执行器</small></li>
<li><a href="https://jasmine.github.io" target="_blank" rel="noopener">Jasmine</a> - <small>行为驱动测试框架</small></li>
<li><a href="http://airbnb.io/enzyme" target="_blank" rel="noopener">Enzyme</a> - <small>React 单元测试套件</small></li>
<li><a href="http://phantomjs.org" target="_blank" rel="noopener">PhantomJS</a> - <small>基于 WebKit 的服务器端 JavaScript API，无需浏览器的 Web 测试</small></li>
</ul>
</li>
<li>E2E Testing <a href="https://zhidao.baidu.com/question/29346350.html" target="_blank" rel="noopener">端到端测试</a><ul>
<li><a href="http://nightwatchjs.org/" target="_blank">Nightwatch</a> - <small>基于 Node 的验收测试框架，使用 <a href="http://www.seleniumhq.org/" target="_blank">Selenium WebDriver API</a> 以将 Web 应用测试自动化</small></li>
</ul>
</li>
</ul>
<h2 id="一次配置，多处使用"><a href="#一次配置，多处使用" class="headerlink" title="一次配置，多处使用"></a>一次配置，多处使用</h2><p>项目结构如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/hd</span><br><span class="line"> - <span class="regexp">/components /</span><span class="regexp">/ 基于组件化思想，把活动页面通用的部分提出来作为公共组件，开发时可按需引入</span></span><br><span class="line"><span class="regexp"> - /</span>constants <span class="comment">// 定义全局使用的常量</span></span><br><span class="line"> - <span class="regexp">/coverage /</span><span class="regexp">/ 单元测试覆盖率报告</span></span><br><span class="line"><span class="regexp"> - /</span>libs <span class="comment">// 常用库函数（获取用户详情、handlebars helper 等）</span></span><br><span class="line"> - <span class="regexp">/public /</span><span class="regexp">/ Webpack 打包编译后文件存放目录</span></span><br><span class="line"><span class="regexp"> - /</span>routes <span class="comment">// Koa 路由</span></span><br><span class="line"> - <span class="regexp">/SCSS /</span><span class="regexp">/ 通用 SCSS 样式</span></span><br><span class="line"><span class="regexp"> - /</span>src <span class="comment">// 开发目录</span></span><br><span class="line"> - <span class="regexp">/test /</span><span class="regexp">/ 测试（unit、e2e）</span></span><br><span class="line"><span class="regexp"> - /u</span>tils <span class="comment">// 工具函数</span></span><br><span class="line"> - <span class="regexp">/views /</span><span class="regexp">/ Koa 模板</span></span><br><span class="line"><span class="regexp"> - /</span>webpack <span class="comment">// 拆分的 Webpack 任务（若全部写在 webpack.config.js 中，会导致文件臃肿、不便阅读）</span></span><br><span class="line"> - .babelrc <span class="comment">// Babel 配置</span></span><br><span class="line"> - .eslintrc <span class="comment">// ESLint 配置</span></span><br><span class="line"> - .gitignore <span class="comment">// Git 忽略定义</span></span><br><span class="line"> - CHANGELOG.md <span class="comment">// 更新日志</span></span><br><span class="line"> - karma.conf.js <span class="comment">// Karma 配置</span></span><br><span class="line"> - nightwatch.conf.js <span class="comment">// Nightwatch 配置</span></span><br><span class="line"> - package.json <span class="comment">// NPM Package JSON</span></span><br><span class="line"> - postcss.config.js <span class="comment">// Post CSS 配置</span></span><br><span class="line"> - README.md <span class="comment">// 说明文档</span></span><br><span class="line"> - webpack.config.babel.js <span class="comment">// Webpack 配置</span></span><br><span class="line"> - yarn.lock <span class="comment">// Yarn 锁（锁定 NPM 依赖包的版本）</span></span><br></pre></td></tr></table></figure>
<p>为了设计出一个通用的开发环境，满足不同的活动业务需求（可能来自运营、市场、公益等部门），需要做到彼此的项目隔离、互不影响。因此在 <code>/src</code> 目录下的第一子级是各个活动项目的源代码（命名采取：年份-{Project Name}，便于日后检索也可防止冲突）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/src</span><br><span class="line"> - <span class="regexp">/2017-lovers /</span><span class="regexp">/ 2017 情人节活动</span></span><br><span class="line"><span class="regexp"> - /</span><span class="number">2017</span>-trees <span class="comment">// 2017 植树节活动</span></span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>因为使用了 webpack，开发时在终端输入指定的参数，定位到具体的某个活动项目，webpack 会根据当前的项目目录执行编译任务。为了适配这种通用性，会要求目录结构、文件名等要满足特定的规则：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 举个栗子</span></span><br><span class="line">/<span class="number">2017</span>-nightlive</span><br><span class="line"> - <span class="regexp">/components /</span><span class="regexp">/ 该项目用到的 React 组件</span></span><br><span class="line"><span class="regexp"> - /img</span> <span class="comment">// 图片文件</span></span><br><span class="line"> - <span class="regexp">/SCSS /</span><span class="regexp">/ 样式文件</span></span><br><span class="line"><span class="regexp"> - /</span>sprite <span class="comment">// 将要被生成雪碧图的图标文件</span></span><br><span class="line"> - index.hbs <span class="comment">// 项目模板</span></span><br><span class="line"> - index.js <span class="comment">// Webpack 编译时的 entry 文件</span></span><br></pre></td></tr></table></figure>
<h2 id="Babel-6-x"><a href="#Babel-6-x" class="headerlink" title="Babel (6.x)"></a>Babel (6.x)</h2><blockquote>
<p>可以将 ES6 语法转换成 ES5 语法，让我们在使用 ES6 新特性编写代码的同时，不需要考虑各大浏览器具体的兼容性情况。</p>
</blockquote>
<p>这里选择了 Babel，主要有以下几个原因：</p>
<ul>
<li>Babel 对 ES6 的支持程度比其它同类更高或相当</li>
<li>Babel 拥有完善的文档和较好体验的在线编译环境</li>
<li>Babel 使用广泛，用户基础好</li>
</ul>
<p>关于第一点原因的主要数据支持可以在 <a href="https://babeljs.io" target="_blank" rel="noopener">Bebel 官网</a>，我们可以看到不同版本 Babel 对 ES6 跟进和支持的情况，另外，关于在线编译平台，可以访问官网进行体验，这对于研究 Babel 编译结果十分方便。</p>
<p>关于 Babel 的接入和使用方法，社区上的资料很多，这里配合构建工具 webpack，只需要安装插件 <a href="https://github.com/babel/babel-loader" target="_blank">babel-loader</a> 并在 <a href="https://webpack.js.org/configuration/module" target="_blank">webpack.module.rules</a> 中进行相关配置即可使用。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><a href="https://babeljs.io/docs/usage/polyfill" target="_blank" rel="noopener">babel-polyfill</a></h3><blockquote>
<p>Babel 默认只转换新的 JavaScript 语法，而不转换新的 API。</p>
</blockquote>
<p>Babel 可以编译 <code>let</code>、<code>const</code> 等特性，但是诸如 Iterator、Generator、Reflect、Promise 等全局对象，或者数组实例的 find 这些新的方法并不会得到编译。如果想让这个方法运行，必须使用 babel-polyfill，<strong>同时要保证这个 polyfill 在你的所有其他脚本之前就要加载执行。因为编译产出为 ES5 代码，所以又要处在 ES5 垫片 <a href="https://github.com/es-shims/es5-shim" target="_blank" rel="noopener">es5-shim</a>、ES6 垫片 <a href="https://github.com/paulmillr/es6-shim" target="_blank" rel="noopener">es6-shim</a> 之后。</strong>（垫片就是在低级环境中使用高级语法时，手动实现高级功能，模拟高级环境）</p>
<p>实际情况中，在公共组件 <code>&lt;App /&gt;</code> 中开头引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Babel Polyfill</span></span><br><span class="line"><span class="comment">// Error: only one instance of babel-polyfill is allowed</span></span><br><span class="line"><span class="comment">// https://github.com/stylelint/stylelint/issues/1316</span></span><br><span class="line"><span class="keyword">if</span> (!global._babelPolyfill) &#123; <span class="comment">// 为了解决重复引入的问题</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'babel-polyfill'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>项目开发时将这个组件作为最外层容器使用即可。</p>
<h3 id="Babel-配置-Presets（转码规则）"><a href="#Babel-配置-Presets（转码规则）" class="headerlink" title="Babel 配置 - Presets（转码规则）"></a>Babel 配置 - Presets（转码规则）</h3><h4 id="-1"><a href="#-1" class="headerlink" title=""></a><a href="http://babeljs.io/docs/plugins/preset-env" target="_blank" rel="noopener">babel-preset-env</a></h4><p>随着浏览器和 Node.js 的版本迭代，对新语法的支持也越来越好。但非常尴尬的是，我们总是使用 Babel 把所有代码一股脑转换成 ES5。这意味着我们抛弃了性能优秀的 <code>let</code>、<code>const</code> 关键字，放弃了简短的代码，而选择了又长又丑像坨屎的经过变换后的代码。</p>
<p>即使仅仅将代码跑在对 ES5 支持度在 99% 的 Node 6 上，一旦使用了 <code>import</code> 关键字，你就得用 Babel 对代码进行转换，一般还是全部转换为 ES5，辣鸡 Node.js 竟然还不支持 <code>import</code> 和 <code>export。</code></p>
<blockquote>
<p>那么有没有什么工具能智能识别当前运行环境，并且进行适当的转换，以及填充适当的 polyfill 呢？</p>
</blockquote>
<p>还真有，而且是 Babel 官方提供的，一个名为 babel-preset-env 的插件。它不需要你自行添加任何 preset，比如我们最常用的 es2015，它能根据设置智能转换代码。</p>
<h4 id="-2"><a href="#-2" class="headerlink" title=""></a><a href="http://babeljs.io/docs/plugins/preset-react/" target="_blank" rel="noopener">babel-preset-react</a></h4><p>React 转码规则，支持编译 .jsx 文件。</p>
<h4 id="-3"><a href="#-3" class="headerlink" title=""></a><a href="https://babeljs.io/docs/plugins/preset-stage-0" target="_blank" rel="noopener">babel-preset-stage-0</a></h4><p>ES7 不同阶段语法提案的转码规则，涵盖了 <a href="https://babeljs.io/docs/plugins/preset-stage-1" target="_blank" rel="noopener">stage-1</a>、<a href="https://babeljs.io/docs/plugins/preset-stage-2" target="_blank" rel="noopener">stage-2</a>、<a href="https://babeljs.io/docs/plugins/preset-stage-3" target="_blank" rel="noopener">stage-3</a>。</p>
<h3 id="Babel-配置-Plugins（插件）"><a href="#Babel-配置-Plugins（插件）" class="headerlink" title="Babel 配置 - Plugins（插件）"></a>Babel 配置 - Plugins（插件）</h3><h4 id="-4"><a href="#-4" class="headerlink" title=""></a><a href="https://github.com/oliviertassinari/babel-plugin-transform-react-remove-prop-types" target="_blank" rel="noopener">babel-plugin-transform-react-remove-prop-types</a></h4><p>在 webpack production 编译模式下移除 React propTypes 定义来减小编译后的 js 文件体积。</p>
<h4 id="-5"><a href="#-5" class="headerlink" title=""></a><a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener">babel-plugin-import</a></h4><p>实现 <a href="https://mobile.ant.design" target="_blank" rel="noopener">antd-mobile</a> 的按需加载，另外此插件配合 style 属性可以做到模块样式的按需自动加载。</p>
<h3 id="Babel-配置文件"><a href="#Babel-配置文件" class="headerlink" title="Babel 配置文件"></a>Babel 配置文件</h3><p>Babel 的配置文件是 <code>.babelrc</code>，存放在项目的根目录下，用来设置上述转码规则和插件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">    <span class="string">"env"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">    <span class="string">"stage-0"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"env"</span>: &#123;</span><br><span class="line">    <span class="string">"production"</span>: &#123;</span><br><span class="line">      <span class="string">"plugins"</span>: [</span><br><span class="line">        [<span class="string">"transform-react-remove-prop-types"</span>, &#123;</span><br><span class="line">          <span class="string">"mode"</span>: <span class="string">"wrap"</span>,</span><br><span class="line">          <span class="string">"ignoreFilenames"</span>: [<span class="string">"node_modules"</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"plugins"</span>: [</span><br><span class="line">    [<span class="string">"import"</span>, &#123;</span><br><span class="line">      <span class="string">"style"</span>: <span class="string">"css"</span>,</span><br><span class="line">      <span class="string">"libraryName"</span>: <span class="string">"antd-mobile"</span></span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Babel-ESLint"><a href="#Babel-ESLint" class="headerlink" title="Babel ESLint"></a>Babel ESLint</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc</span></span><br><span class="line">parser: babel-eslint <span class="comment">// ESLint 解析器</span></span><br></pre></td></tr></table></figure>
<p>ESLint 允许自定义解析器。但是 ESLint 不支持 Babel 支持的一些语法节点。使用 <a href="https://github.com/babel/babel-eslint" target="_blank" rel="noopener">babel-eslint</a> 时，ESLint 将被修改，代码将转换为 ESLint 可以理解的代码。所有位置信息（如行号，列）也保留，以便轻松跟踪错误。</p>
<h2 id="Webpack-2-x"><a href="#Webpack-2-x" class="headerlink" title="Webpack (2.x)"></a>Webpack (2.x)</h2><h3 id="配置-amp-ES6"><a href="#配置-amp-ES6" class="headerlink" title="配置 &amp; ES6"></a>配置 &amp; ES6</h3><p>用 <code>webpack.config.babel.js</code> 命名 Webpack 的配置文件，会先经过 Babel 的转码，So 可以使用 ES6 语法咯。</p>
<h3 id="按需配置"><a href="#按需配置" class="headerlink" title="按需配置"></a>按需配置</h3><p>webpack 2.x 默认支持从命令行传参到配置文件实现按需配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Command line</span><br><span class="line">webpack -- --env.x=xxx</span><br></pre></td></tr></table></figure>
<h3 id="忽略解析"><a href="#忽略解析" class="headerlink" title="忽略解析"></a>忽略解析</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noParse: vendor.map(<span class="function"><span class="params">v</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`<span class="subst">$&#123;v&#125;</span>$`</span>))</span><br></pre></td></tr></table></figure>
<p>webpack.module.noParse 可防止 webpack 解析那些任何与给定正则表达式相匹配的文件，忽略大型的 library 可以提高构建性能。</p>
<h3 id="babel-loader-之-cacheDirectory"><a href="#babel-loader-之-cacheDirectory" class="headerlink" title="babel-loader 之 cacheDirectory"></a>babel-loader 之 cacheDirectory</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use: <span class="string">'babel-loader?cacheDirectory'</span></span><br></pre></td></tr></table></figure>
<p><code>cacheDirectory</code> 可以缓存处理过的模块，对于没有修改过的文件不会再重新编译，有着2倍以上的速度提升，这对于 rebuild 有着非常大的性能提升。</p>
<h3 id="动态匹配路径"><a href="#动态匹配路径" class="headerlink" title="动态匹配路径"></a>动态匹配路径</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">use: <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> loaders = [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'file-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        regExp: <span class="regexp">/components\/(.*)\//</span>,</span><br><span class="line">        name: <span class="string">`[1]/[name]-[hash:8].[ext]`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isProd) &#123;</span><br><span class="line">    loaders.push(imageWebpackLoaderRule)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> loaders</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>regExp 中匹配到的分组内容将会对应到下面的 [1] 处。</p>
<h3 id="Webpack-Hash-的困扰"><a href="#Webpack-Hash-的困扰" class="headerlink" title="Webpack Hash 的困扰"></a>Webpack Hash 的困扰</h3><p>由于 Webpack 的<a href="https://github.com/webpack/webpack/issues/1315" target="_blank" rel="noopener">一个问题</a>，<br>生成哈希值的方法并不是确定的。为了保证哈希值是根据文件内容生成的，<br>需要使用 <a href="https://github.com/erm0l0v/webpack-md5-hash" target="_blank" rel="noopener">webpack-md5-hash</a> 插件。</p>
<p>当更改了代码的任何一部分，即使剩下的文件内容没有被修改，入口也会被更新以放入新的清单。这样反过来也就导致新的哈希值，影响了长期缓存。为了修复这个问题，使用插件 <a href="https://github.com/soundcloud/chunk-manifest-webpack-plugin" target="_blank" rel="noopener">chunk-manifest-webpack-plugin</a> 来把清单导出到单独的 JSON 文件中。</p>
<blockquote>
<p>延伸阅读：<a href="https://sebastianblade.com/using-webpack-to-achieve-long-term-cache" target="_blank" rel="noopener">用 webpack 实现持久化缓存</a></p>
</blockquote>
<h3 id="Webpack-Clean-父级目录的权限问题"><a href="#Webpack-Clean-父级目录的权限问题" class="headerlink" title="Webpack Clean 父级目录的权限问题"></a>Webpack Clean 父级目录的权限问题</h3><p>在任务开始时，经常会使用插件 <a href="https://github.com/johnagan/clean-webpack-plugin" target="_blank" rel="noopener">clean-webpack-plugin</a> 来清除上次打包生成的文件，以保证目录的干净。但是，如果你想要清除父级目录，会遇到一个错误提示：</p>
<blockquote>
<p>xxx/xxx must be inside the project root…</p>
</blockquote>
<p>解决办法是设置 <code>root</code> 参数，指向 webpack 编译时的当前目录。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CleanPlugin(somePath, &#123;</span><br><span class="line">  root: process.cwd()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="提升-Webpack-压缩-JS-文件的速度"><a href="#提升-Webpack-压缩-JS-文件的速度" class="headerlink" title="提升 Webpack 压缩 JS 文件的速度"></a>提升 Webpack 压缩 JS 文件的速度</h3><p>Webpack 提供的 UglifyJS 插件由于采用单线程压缩，速度很慢。使用 <a href="https://github.com/gdborton/webpack-parallel-uglify-plugin" target="_blank" rel="noopener">webpack-parallel-uglify-plugin</a> 可以并行运行 UglifyJS 插件，可有效减少构建时间。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-06-23</span><i class="fa fa-tag"></i><a href="/blog/categories/前端技术/" title="前端技术" class="tag">前端技术 </a><a href="/blog/tags/workflow/" title="workflow" class="tag">workflow </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://l19861225q.github.io/blog/2017/06/23/framework-qa/,6K,前端项目架构时遇到的问题,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/blog/2017/06/29/interactive-npm-scripts/" title="交互式的 NPM Scripts" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/blog/2016/08/29/How-to-install-QConf-on-OSX/" title="如何在 OSX 上运行 QConf" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/blog/js/jquery.js"></script><script src="/blog/js/jquery-migrate-1.2.1.min.js"></script><script src="/blog/js/jquery.appear.js"></script></body></html>