<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="6K"><title>如何在 OSX 上运行 QConf · 6K</title><meta name="description" content="最近，由于项目需要，需要在 Mac 上安装 QConf，其中的过程真是山路十八弯…
废话不多说，直接上菜！

1.安装 QConf
git clone https://github.com/Qihoo360/QConf.git
cd QConf &amp;amp;&amp;amp; mkdir build &amp;amp"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/blog/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/blog/css/style.css"><link rel="stylesheet" href="/blog/css/blog_basic.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/blog/images/avatar.png" style="width:150px;"><h3 title=""><a href="/">6K</a></h3><div class="description"><p>认真做事 低调做人</p></div></div></div><ul class="social-links"></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/blog/">首页</a></li><li><a href="https://l19861225q.github.io/blog/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>如何在 OSX 上运行 QConf</a></h3></div><div class="post-content"><p>最近，由于项目需要，需要在 Mac 上安装 <a href="https://github.com/Qihoo360/QConf" target="_blank">QConf</a>，其中的过程真是山路十八弯…</p>
<p>废话不多说，直接上菜！</p>
<a id="more"></a>
<h3 id="1-安装-QConf"><a href="#1-安装-QConf" class="headerlink" title="1.安装 QConf"></a>1.安装 QConf</h3><ul>
<li><code>git clone https://github.com/Qihoo360/QConf.git</code></li>
<li><code>cd QConf &amp;&amp; mkdir build &amp;&amp; cd build &amp;&amp; cmake ..</code><br><i>这里 <code>cmake ..</code> 第一次可能会报错，直接无视，再 <code>cmake ..</code> 一遍就可以了。</i></li>
<li><code>make</code></li>
<li><code>sudo make install</code><br><i>安装完成以后，默认应该是在 <code>/usr/local/qconf</code> 这个路径下面</i></li>
</ul>
<h3 id="2-问题处理"><a href="#2-问题处理" class="headerlink" title="2.问题处理"></a>2.<a href="https://github.com/Qihoo360/QConf/wiki/FAQ" target="_blank">问题处理</a></h3><h4 id="使用-qconf-需要调整共享内存限制"><a href="#使用-qconf-需要调整共享内存限制" class="headerlink" title="使用 qconf 需要调整共享内存限制"></a>使用 qconf 需要调整共享内存限制</h4><p><strong>通过 sysctl -a | grep shm 查看当前的共享内存上限的大小，如果不足2G，则进行如下操作：</strong></p>
<blockquote>
<p>修改共享内存上限，使当前正在运行的系统生效 <code>需要 sudo -s 下执行</code><br>Mac 执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl kern.sysv.shmmax=2048000000</span><br><span class="line">sysctl kern.sysv.shmall=1073741824</span><br></pre></td></tr></table></figure></p>
<p>修改共享内存上限，使机器重启时生效，需要在 /etc/sysctl.conf 添加：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kern.sysv.shmmax=2048000000</span><br><span class="line">kern.sysv.shmall=1073741824</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="3-安装-flock"><a href="#3-安装-flock" class="headerlink" title="3.安装 flock"></a>3.安装 flock</h3><blockquote>
<p><code>/usr/local/qconf/bin/agent-cmd.sh:355</code> 用到了 <code>flock</code> 命令，但 OSX 并不支持，需要手动安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap discoteq/discoteq</span><br><span class="line">brew install flock</span><br></pre></td></tr></table></figure>
<p>装好以后，修改（需要 sudo） <code>/usr/local/qconf/bin/agent-cmd.sh:355</code> 去掉 <code>-e</code> 参数，否则会报错。</p>
<h3 id="4-启动-QConf"><a href="#4-启动-QConf" class="headerlink" title="4.启动 QConf"></a>4.启动 QConf</h3><ul>
<li><code>cd /usr/local/qconf/bin &amp;&amp; sh agent-cmd.sh start</code></li>
</ul>
<h3 id="5-安装-QConf-的-Node-驱动-node-qconf"><a href="#5-安装-QConf-的-Node-驱动-node-qconf" class="headerlink" title="5.安装 QConf 的 Node 驱动 node-qconf"></a>5.安装 QConf 的 Node 驱动 <a href="https://www.npmjs.com/package/node-qconf" target="_blank">node-qconf</a></h3><p>当然也有 C++ PHP 等 <a href="https://github.com/Qihoo360/QConf/tree/master/driver" target="_blank">其他驱动</a> 咯</p>
<ul>
<li>设置环境变量 .bashrc/.zshrc/…<br><code>export QCONF_INSTALL=/usr/local/qconf</code></li>
<li><code>npm install node-qconf</code></li>
</ul>
<h3 id="6-愉快的玩耍吧"><a href="#6-愉快的玩耍吧" class="headerlink" title="6.愉快的玩耍吧"></a>6.愉快的玩耍吧</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> qconf = <span class="built_in">require</span>(<span class="string">'node-qconf'</span>);</span><br><span class="line">  qconf.getAllHost();</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="A-Big-Hole-一个大坑！"><a href="#A-Big-Hole-一个大坑！" class="headerlink" title="A Big Hole (一个大坑！)"></a>A Big Hole (一个大坑！)</h2><h5 id="运行时，如果提示找不到-libqconf-dylib-这货怎么办？"><a href="#运行时，如果提示找不到-libqconf-dylib-这货怎么办？" class="headerlink" title="运行时，如果提示找不到 libqconf.dylib 这货怎么办？"></a>运行时，如果提示找不到 <code>libqconf.dylib</code> 这货怎么办？</h5><p>多半是因为 <code>libqconf.dylib</code> 这货的路径设置问题。<br>其实这货就在 <code>/usr/local/qconf/lib</code> 下，所以我也尝试过设置环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> DYLD_LIBRARY_PATH=<span class="variable">$DYLD_LIBRARY_PATH</span>:<span class="variable">$QCONF_INSTALL</span>/lib</span><br></pre></td></tr></table></figure>
<p>确实，这样设置以后在 Node 命令行模式下加载 <code>node-qconf</code> 已经可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node</span><br><span class="line">&gt; require(<span class="string">'node-qconf'</span>)</span><br><span class="line">&gt; // No error, so happy ~</span><br></pre></td></tr></table></figure>
<p>但是！如果用了类似 <a href="http://nodemon.io/" target="_blank">nodemon</a> 来启动项目，还是会提示找不到这货的诡异错误。原因呢…</p>
<p>Presumably, you are running El Capitan (OS X 10.11). It’s a side effect of System Integrity Protection. From the <a href="https://developer.apple.com/library/prerelease/mac/documentation/Security/Conceptual/System_Integrity_Protection_Guide/RuntimeProtections/RuntimeProtections.html" target="_blank">System Integrity Protection Guide: Runtime Protections<a> article:<br><br></a></a></p>
<blockquote>
<p>When a process is started, the kernel checks to see whether the main executable is protected on disk or is signed with an special system entitlement. If either is true, then a flag is set to denote that it is protected against modification. …<br><br><br><br>… Any dynamic linker (dyld) environment variables, such as DYLD_LIBRARY_PATH, are purged when launching protected processes.</p>
</blockquote>
<p><i>参考</i></p>
<ul>
<li><a href="http://stackoverflow.com/questions/35568122/why-isnt-dyld-library-path-being-propagated-here" target="_blank" rel="noopener">Why isn’t DYLD_LIBRARY_PATH being propagated here?</a></li>
</ul>
<p>额，好吧，我们设置的 DYLD_* 这些环境变量都在启动一个受保护的进程时被净化掉了！</p>
<p>后来仔细发现，报错的文件是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./node_modules/node-qconf/build/Release/qconf.node</span><br></pre></td></tr></table></figure>
<p>这货还是个二进制文件！&gt;_&lt;<br>那么有什么办法可以查看它在启动时引用的 Shared library paths？</p>
<h5 id="otool"><a href="#otool" class="headerlink" title="otool"></a>otool</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./node_modules/node-qconf/build/Release/</span><br><span class="line">otool -L qconf.node</span><br><span class="line"></span><br><span class="line">// qconf.node:</span><br><span class="line">//   libqconf.dylib (compatibility version 0.0.0, current version 0.0.0)</span><br><span class="line">//   ...</span><br></pre></td></tr></table></figure>
<p>看来，的确是路径问题，它从当前目录引用了 <code>libqconf.dylib</code><br>好吧，那么有什么办法可以来修改这个路径？</p>
<h5 id="install-name-tool"><a href="#install-name-tool" class="headerlink" title="install_name_tool"></a>install_name_tool</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install_name_tool -change libqconf.dylib /usr/<span class="built_in">local</span>/qconf/lib/libqconf.dylib ./qconf.node</span><br></pre></td></tr></table></figure>
<p>这时再执行 <code>otool -L qconf.node</code> 会发现已经被设置成为正确的路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qconf.node:</span><br><span class="line">  /usr/<span class="built_in">local</span>/qconf/lib/libqconf.dylib (compatibility version 0.0.0, current version 0.0.0)</span><br></pre></td></tr></table></figure></p>
<p>大功告成！再也不会看到烦人的找不到 .dylib 的错误了。但这个方法只能算是一种 hack，如果重新安装了 <code>node-qconf</code>，还是需要重新 hack 的。</p>
<p><i>参考</i></p>
<ul>
<li><a href="http://www.jianshu.com/p/193ba07dadcf" target="_blank" rel="noopener">两个 Xcode 的实用工具： otool 和 install_name_tool</a></li>
<li><a href="http://superuser.com/questions/282450/where-do-i-set-dyld-library-path-on-mac-os-x-and-is-it-a-good-idea" target="_blank" rel="noopener">Where do I set DYLD_LIBRARY_PATH on Mac OS X, and is it a good idea?</a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-08-29</span><i class="fa fa-tag"></i><a href="/blog/categories/OSX/" title="OSX" class="tag">OSX </a><a href="/blog/tags/qconf/" title="qconf" class="tag">qconf </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://l19861225q.github.io/blog/2016/08/29/How-to-install-QConf-on-OSX/,6K,如何在 OSX 上运行 QConf,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/blog/2017/06/23/framework-qa/" title="前端项目架构时遇到的问题" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/blog/2016/07/17/Hexo-deploy-fail/" title="Hexo 部署失败？" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/blog/js/jquery.js"></script><script src="/blog/js/jquery-migrate-1.2.1.min.js"></script><script src="/blog/js/jquery.appear.js"></script></body></html>